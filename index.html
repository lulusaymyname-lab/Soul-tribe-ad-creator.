
<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ad & Campaign Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <!-- PayPal SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=AQRSVj2hhAqWy7TCjAWRB4mxj5Y3B87JdMGtBUIGCEKMFMWLvep2pRGDGyjTebgI2N760RB1jUrsmZGW&currency=USD"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: #0b0b15;
            color: #fff;
            margin: 0;
        }
        .loading-overlay {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .ad-preview-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .select2-container--default .select2-selection--multiple {
            background-color: #1f2937;
            border-radius: 0.75rem;
            border: 2px solid #4b5563;
            padding: 0.5rem;
        }
        .select2-container--default .select2-selection--multiple .select2-selection__rendered { color: #fff; }
        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            background-color: #4f46e5; color: white; border: none; border-radius: 0.5rem;
        }
        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove { color: white; }
        .select2-dropdown { background-color: #1f2937; border: 1px solid #4b5563; }
        .select2-container--default .select2-results__option--highlighted[aria-selected] { background-color: #4f46e5; }
        .select2-results__option { color: #d1d5db; }
        .modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.6);
            justify-content: center; align-items: center; z-index: 100;
        }
        .modal.active { display: flex; }
        @keyframes scroll {
            to {
                transform: translate(calc(-50% - 0.5rem));
            }
        }
        .scroller {
            max-width: 100%;
            overflow: hidden;
            -webkit-mask: linear-gradient(90deg, transparent, white 20%, white 80%, transparent);
            mask: linear-gradient(90deg, transparent, white 20%, white 80%, transparent);
        }
        .scroller__inner {
            display: flex;
            gap: 1rem;
            padding-block: 1rem;
            width: max-content;
            animation: scroll 60s linear infinite;
        }
        .scroller__inner img {
            height: 180px;
            width: auto;
            border-radius: 0.75rem;
            object-fit: cover;
        }
        .scroller[data-animated="true"] {
            overflow: hidden;
        }
        .scroller[data-animated="true"] .scroller__inner {
            width: max-content;
            flex-wrap: nowrap;
        }
        .scroller:hover .scroller__inner {
            animation-play-state: paused;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="landingPage">
        <header class="text-center py-12 px-5 bg-gradient-to-b from-[#1b1b2f] to-[#0b0b15]">
            <h1 class="text-4xl font-bold mb-2">Soul Tribe Ad & Campaign Generator</h1>
            <p class="text-gray-300 text-lg">Create scroll-stopping ads in seconds with AI-powered design</p>
            <a href="#appSections" class="mt-6 inline-block bg-pink-600 text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:bg-pink-700 transition">
                Try Now (Test Drive)
            </a>
        </header>

        <section class="py-16 px-6 max-w-7xl mx-auto">
            <h2 class="text-3xl font-bold text-center mb-4">What You Can Create</h2>
            <p class="text-center text-lg text-gray-400 mb-12 max-w-3xl mx-auto">
                Here are real examples generated by the Soul Tribe Ad & Campaign Generator.
                In just seconds, you can create professional, ready-to-post ads for Instagram, Facebook, X, and Pinterest —
                tailored to your product or campaign.
            </p>
            <div class="scroller" data-speed="slow">
                <div class="scroller__inner">
                    <!-- Images will be dynamically added here -->
                </div>
            </div>
        </section>

        <section class="py-16 px-6 max-w-7xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-gray-800 rounded-2xl p-8 border border-gray-700 flex flex-col h-full">
                    <div class="flex-grow">
                        <div class="w-12 h-12 bg-indigo-600/20 rounded-full flex items-center justify-center mb-4">
                            <svg class="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                        </div>
                        <h3 class="text-2xl font-bold mb-2">Launch Ads Directly to Meta</h3>
                        <p class="text-gray-400 mb-6">Now, with just a single click, you can launch ads directly from Projects to Meta, saving time and simplifying the process.</p>
                    </div>
                    <img src="https://i.imgur.com/RzmcLQd.png" alt="Ad example for Meta launch" class="rounded-xl object-cover w-full h-64 mt-auto">
                </div>
                <div class="bg-gray-800 rounded-2xl p-8 border border-gray-700 flex flex-col h-full">
                    <div class="flex-grow">
                        <div class="w-12 h-12 bg-pink-600/20 rounded-full flex items-center justify-center mb-4">
                            <svg class="w-6 h-6 text-pink-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        </div>
                        <h3 class="text-2xl font-bold mb-2">Monitor Ad Performance & Health</h3>
                        <p class="text-gray-400 mb-6">Easily monitor ad performance with the new Ad Level View in My Ads. Track key metrics, adjust ad status, and check ad health—all in one place.</p>
                    </div>
                    <img src="https://i.imgur.com/7xL8pXD.png" alt="Ad performance dashboard" class="rounded-xl object-cover w-full h-64 mt-auto">
                </div>
            </div>
        </section>

        <section class="bg-[#1b1b2f] py-16 px-6">
            <h2 class="text-3xl font-bold text-center mb-10">See the Magic: Before & After</h2>
            <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8 items-center text-center md:text-left">
                <div><img src="https://i.imgur.com/Sn3IZyz.png" alt="Before: Raw product shot" class="rounded-xl shadow-lg border border-gray-700 mx-auto"><p class="mt-4 text-gray-400">Before: A standard product image.</p></div>
                <div class="relative"><img src="https://i.imgur.com/RzmcLQd.png" alt="After: AI-generated ad" class="rounded-xl shadow-lg border border-pink-500 mx-auto"><p class="mt-4 text-gray-400">After: A professional, AI-generated ad.</p><div class="absolute inset-0 bg-white/10 rounded-xl"></div></div>
                <div><img src="https://i.imgur.com/sbKrFep.png" alt="Before: Raw product shot" class="rounded-xl shadow-lg border border-gray-700 mx-auto"><p class="mt-4 text-gray-400">Before: A standard product image.</p></div>
                <div class="relative"><img src="https://i.imgur.com/PvoIuCN.png" alt="After: AI-generated ad" class="rounded-xl shadow-lg border border-pink-500 mx-auto"><p class="mt-4 text-gray-400">After: A professional, AI-generated ad.</p><div class="absolute inset-0 bg-white/10 rounded-xl"></div></div>
            </div>
        </section>

        <div id="appSections" class="py-16 px-6">
            <div class="flex justify-center space-x-4 mb-10">
                <button id="showAdGeneratorBtn" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-xl transition-colors">Ad Generator</button>
                <button id="showCampaignMakerBtn" class="bg-gray-800 text-white font-bold py-2 px-6 rounded-xl transition-colors">Campaign Maker</button>
                <button id="showDashboardBtn" class="bg-gray-800 text-white font-bold py-2 px-6 rounded-xl transition-colors">My Ads Dashboard</button>
            </div>

            <div id="adGenerator" class="flex flex-col lg:flex-row space-y-6 lg:space-y-0 lg:space-x-6">
                <div class="flex-1 flex flex-col space-y-6">
                    <div class="p-6 bg-gray-800 rounded-2xl border border-gray-700 shadow-sm"><h2 class="text-2xl font-bold text-white mb-4">Generate Ad</h2><p class="text-sm text-gray-400 mb-4">Describe the background, product placement, and ad copy style.</p><div class="bg-gray-700 text-white p-3 rounded-xl mb-4 text-sm border border-gray-600"><p><strong>Heads up!</strong> AI generation can be creative. You may need to run the generation process a few times. Be as specific as possible!</p></div><textarea id="backgroundPrompt" class="w-full h-24 p-3 text-base bg-gray-900 text-white border-2 border-gray-600 rounded-xl focus:ring-2 focus:ring-indigo-500" placeholder="A sleek marble podium..."></textarea><label id="uploadLabel" class="cursor-pointer mt-4 w-full text-gray-200 font-bold py-3 px-6 rounded-xl shadow-md text-center bg-gray-700 hover:bg-gray-600 block transition-colors">Upload Product Image<input type="file" id="productImageUpload" accept="image/*" class="hidden" /></label><button id="generateAdBtn" class="mt-4 w-full bg-indigo-600 text-white font-bold py-4 px-8 rounded-xl hover:bg-indigo-700 transition-colors">Generate Ad</button></div>
                    <div id="adCopyContainer" class="p-6 bg-gray-800 rounded-2xl border border-gray-700 hidden"><h3 class="text-xl font-bold mb-2">Generated Ad Copy:</h3><div id="adCopyText" class="text-gray-300"></div><button id="copyAdBtn" class="mt-4 w-full bg-gray-700 text-white font-bold py-3 px-6 rounded-xl hover:bg-gray-600 transition-colors">Copy Ad Text</button></div>
                    <button id="resetBtn" class="w-full bg-red-500 text-white font-bold py-3 px-6 rounded-xl hover:bg-red-600 transition-colors">Reset</button>
                </div>
                <div class="flex-1 flex flex-col items-center justify-center space-y-4">
                    <div class="relative w-full aspect-[1/1] overflow-hidden rounded-xl shadow-2xl border border-gray-700"><img id="adImage" class="ad-preview-image" /><div id="overlay" class="absolute inset-0 bg-gray-800/80 backdrop-blur-sm loading-overlay text-center p-4"><p id="overlayText" class="text-xl text-gray-300">Enter a prompt and upload an image.</p></div></div>
                    <div id="canvasControls" class="w-full hidden"><button id="downloadBtn" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-green-700 transition-colors">Download Your Ad</button></div>
                    <div id="launchToMetaContainer" class="w-full hidden mt-4"><h3 class="text-lg font-semibold text-center mb-2">Ready to Launch?</h3><button id="launchToMetaBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors">Launch on Facebook & Instagram</button></div>
                </div>
            </div>

            <div id="campaignMaker" class="hidden">
                <div class="p-6 bg-gray-800 rounded-2xl border border-gray-700 shadow-sm"><h2 class="text-2xl font-bold text-white mb-4">Create a Campaign</h2><p class="text-sm text-gray-400 mb-4">Generate copy and visual concepts for multiple platforms at once.</p><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><input type="text" id="productName" class="w-full p-3 text-base bg-gray-900 text-white border-2 border-gray-600 rounded-xl" placeholder="Enter Product Name or Type"><select id="platforms" multiple="multiple" class="w-full"><option value="facebook">Facebook</option><option value="instagram">Instagram</option><option value="pinterest">Pinterest</option><option value="x">X (Twitter)</option></select></div><label id="campaignUploadLabel" class="cursor-pointer w-full text-gray-200 font-bold py-3 px-6 rounded-xl shadow-md text-center bg-gray-700 hover:bg-gray-600 block transition-colors">(Optional) Upload Product Image<input type="file" id="campaignImageUpload" accept="image/*" class="hidden" /></label><button id="generateCampaignBtn" class="mt-4 w-full bg-indigo-600 text-white font-bold py-4 px-8 rounded-xl hover:bg-indigo-700 transition-colors">Generate Campaign</button></div>
                <div id="campaignOutput" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </div>

            <div id="myAdsDashboardSection" class="hidden">
                <div class="flex flex-wrap justify-between items-center mb-10 gap-4"><h2 class="text-3xl font-bold">My Ads Dashboard</h2><button id="addNewAdBtn" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-xl transition-colors hover:bg-indigo-700">Create New Ad</button></div>
                <div class="max-w-7xl mx-auto"><div id="adsDashboardGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"><div class="bg-gray-800 rounded-2xl border border-gray-700 overflow-hidden"><img src="https://i.imgur.com/RzmcLQd.png" alt="Ad Preview" class="w-full h-64 object-cover"><div class="p-6"><h3 class="font-semibold text-white mb-2">"Bomber Jacket" Ad</h3><p class="text-sm text-gray-400 mb-4">Status: <span class="font-semibold text-green-400">Active</span></p><div class="grid grid-cols-3 gap-4 text-center"><div><p class="text-xs text-gray-400">Reach</p><p class="text-lg font-bold text-white">12.5K</p></div><div><p class="text-xs text-gray-400">Clicks</p><p class="text-lg font-bold text-white">1.2K</p></div><div><p class="text-xs text-gray-400">CTR</p><p class="text-lg font-bold text-white">9.6%</p></div></div><button class="mt-4 w-full bg-gray-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">View Performance</button></div></div><div class="bg-gray-800 rounded-2xl border border-gray-700 overflow-hidden"><img src="https://i.imgur.com/5dUY1BS.png" alt="Ad Preview" class="w-full h-64 object-cover"><div class="p-6"><h3 class="font-semibold text-white mb-2">"Skincare Essentials" Promo</h3><p class="text-sm text-gray-400 mb-4">Status: <span class="font-semibold text-red-400">Ended</span></p><div class="grid grid-cols-3 gap-4 text-center"><div><p class="text-xs text-gray-400">Reach</p><p class="text-lg font-bold text-white">98.1K</p></div><div><p class="text-xs text-gray-400">Clicks</p><p class="text-lg font-bold text-white">9.2K</p></div><div><p class="text-xs text-gray-400">CTR</p><p class="text-lg font-bold text-white">9.4%</p></div></div><button class="mt-4 w-full bg-gray-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">View Performance</button></div></div><div id="addNewAdCard" class="bg-gray-800 rounded-2xl border-2 border-dashed border-gray-600 flex items-center justify-center cursor-pointer hover:bg-gray-700 transition-colors min-h-[400px]"><div class="text-center text-gray-400"><svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg><p class="mt-2 font-semibold">Launch a New Ad</p></div></div></div></div>
            </div>
        </div>
        
        <section class="bg-gradient-to-r from-purple-600 to-pink-600 py-16 px-6 text-center">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-4xl md:text-5xl font-extrabold mb-4 leading-tight">Your First 5 Ads are on Us!</h2>
                <p class="text-xl text-gray-100 mb-8">Sign up now for a free account and start creating professional ads instantly. No credit card required.</p>
                <button onclick="openSignupModal()" class="inline-block bg-white text-pink-600 font-bold px-8 py-4 rounded-xl shadow-lg hover:bg-gray-200 transition-colors">Start Your Free Trial</button>
            </div>
        </section>

        <section id="pricing" class="bg-[#1b1b2f] py-16 px-6">
            <h2 class="text-3xl font-bold text-center mb-10">Simple Pricing</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-6xl mx-auto">
                <div class="bg-[#0b0b15] p-8 rounded-2xl"><h3 class="text-2xl font-bold mb-2">Starter</h3><p class="text-4xl font-bold my-4 text-yellow-400">$19<span class="text-base font-normal text-gray-300"> / month</span></p><ul class="text-gray-400 space-y-2"><li>50 Ad downloads / mo</li><li>1 Brand Kit</li><li>Basic analytics</li></ul><div id="paypal-starter-button-container" class="mt-6"></div></div>
                <div class="bg-[#0b0b15] p-8 rounded-2xl border-2 border-pink-500"><h3 class="text-2xl font-bold mb-2">Pro</h3><p class="text-4xl font-bold my-4 text-yellow-400">$49<span class="text-base font-normal text-gray-300"> / month</span></p><ul class="text-gray-400 space-y-2"><li>200 Ad downloads / mo</li><li>3 Brand Kits</li><li>A/B variants</li></ul><div id="paypal-pro-button-container" class="mt-6"></div></div>
                <div class="bg-[#0b0b15] p-8 rounded-2xl"><h3 class="text-2xl font-bold mb-2">Business</h3><p class="text-4xl font-bold my-4 text-yellow-400">$99<span class="text-base font-normal text-gray-300"> / month</span></p><ul class="text-gray-400 space-y-2"><li>Unlimited downloads</li><li>5 seats included</li><li>API access</li></ul><div id="paypal-business-button-container" class="mt-6"></div></div>
            </div>
        </section>
    </div>

    <!-- Modals -->
    <div id="signupModal" class="modal"><div class="bg-gray-800 rounded-2xl shadow-lg max-w-sm w-full p-8 relative border border-gray-700 text-white"><button onclick="closeSignupModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl font-bold">&times;</button><h2 class="text-3xl font-extrabold text-center mb-4">Start Your Free Trial</h2><p class="text-center text-gray-400 mb-6">Enter your email to get started. No credit card needed!</p><form id="signupForm" class="flex flex-col space-y-4"><input type="email" id="signupEmail" placeholder="Enter your email" required class="p-3 rounded-xl border border-gray-700 bg-gray-900 text-white focus:outline-none focus:ring-2 focus:ring-pink-500"><button type="submit" class="bg-pink-600 text-white font-bold py-3 rounded-xl hover:bg-pink-700 transition-colors">Start Free Trial</button></form></div></div>
    <div id="metaConnectModal" class="modal"><div class="bg-gray-800 rounded-2xl shadow-lg max-w-sm w-full p-8 relative border border-gray-700 text-white"><button onclick="closeMetaConnectModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl font-bold">&times;</button><h2 class="text-3xl font-extrabold text-center mb-4">Connect to Meta Ads</h2><p class="text-center text-gray-400 mb-6">Please enter your Meta Ad Account ID to launch your campaign.</p><div class="flex flex-col space-y-4"><input type="text" id="metaAdAccountId" placeholder="Enter your Meta Ad Account ID" required class="p-3 rounded-xl border border-gray-700 bg-gray-900 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"><button id="connectAndLaunchBtn" class="bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition-colors">Connect & Launch</button></div></div></div>

    <div id="messageBox" class="fixed inset-x-0 top-4 mx-auto p-4 bg-green-500 text-white rounded-lg shadow-lg text-center z-50 transform -translate-y-full opacity-0 max-w-md"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        // --- App State & Config ---
        let isTrial = true;
        let trialDownloads = 0;
        const TRIAL_DOWNLOAD_LIMIT = 5;
        const SECURE_API_ENDPOINT = '/api/generate';

        // --- DOM Elements ---
        const DOMElements = {
            signupModal: document.getElementById('signupModal'), metaConnectModal: document.getElementById('metaConnectModal'),
            productImageUpload: document.getElementById('productImageUpload'), uploadLabel: document.getElementById('uploadLabel'),
            backgroundPromptInput: document.getElementById('backgroundPrompt'), generateAdBtn: document.getElementById('generateAdBtn'),
            adImage: document.getElementById('adImage'), overlay: document.getElementById('overlay'),
            overlayText: document.getElementById('overlayText'), adCopyContainer: document.getElementById('adCopyContainer'),
            adCopyText: document.getElementById('adCopyText'), copyAdBtn: document.getElementById('copyAdBtn'),
            resetBtn: document.getElementById('resetBtn'), canvasControls: document.getElementById('canvasControls'),
            downloadBtn: document.getElementById('downloadBtn'), messageBox: document.getElementById('messageBox'),
            showAdGeneratorBtn: document.getElementById('showAdGeneratorBtn'), showCampaignMakerBtn: document.getElementById('showCampaignMakerBtn'),
            adGenerator: document.getElementById('adGenerator'), campaignMaker: document.getElementById('campaignMaker'),
            productNameInput: document.getElementById('productName'), generateCampaignBtn: document.getElementById('generateCampaignBtn'),
            campaignOutput: document.getElementById('campaignOutput'), campaignImageUpload: document.getElementById('campaignImageUpload'),
            campaignUploadLabel: document.getElementById('campaignUploadLabel'), signupForm: document.getElementById('signupForm'),
            showDashboardBtn: document.getElementById('showDashboardBtn'), myAdsDashboardSection: document.getElementById('myAdsDashboardSection'),
            launchToMetaContainer: document.getElementById('launchToMetaContainer'), launchToMetaBtn: document.getElementById('launchToMetaBtn'),
            metaAdAccountIdInput: document.getElementById('metaAdAccountId'), connectAndLaunchBtn: document.getElementById('connectAndLaunchBtn'),
            addNewAdCard: document.getElementById('addNewAdCard'), addNewAdBtn: document.getElementById('addNewAdBtn'),
            signupEmail: document.getElementById('signupEmail'),
        };
        
        let productImageBase64 = null;
        let finalAdImageBase64 = null;
        let campaignImageBase64 = null;

        // --- Helper Functions ---
        function showMessageBox(message, isError = false) {
            const { messageBox } = DOMElements;
            messageBox.textContent = message;
            messageBox.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
            messageBox.className = `fixed inset-x-0 top-4 mx-auto p-4 text-white rounded-lg shadow-lg text-center z-50 transform opacity-100 translate-y-0 max-w-md ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            setTimeout(() => {
                messageBox.className = messageBox.className.replace('opacity-100 translate-y-0', 'opacity-0 -translate-y-full');
            }, 3000);
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        function downloadBase64Image(base64Data, filename) {
            const link = document.createElement('a');
            link.download = filename; link.href = base64Data;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        async function callSecureApi(type, payload) {
            const response = await fetch(SECURE_API_ENDPOINT, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type, payload })
            });
            if (!response.ok) {
                const errorResult = await response.json().catch(() => ({ error: 'Failed to parse error response from server.' }));
                throw new Error(errorResult.error || `Server responded with status: ${response.status}`);
            }
            return response.json();
        }
        
        // --- Modal Logic ---
        function openSignupModal() { DOMElements.signupModal.classList.add('active'); }
        function closeSignupModal() { DOMElements.signupModal.classList.remove('active'); }
        function openMetaConnectModal() {
            if (isTrial) {
                showMessageBox('Please sign up to launch campaigns!', true);
                openSignupModal();
                return;
            }
            if (!finalAdImageBase64 || !DOMElements.adCopyText.textContent) {
                showMessageBox('Please generate an ad first before launching.', true);
                return;
            }
            DOMElements.metaConnectModal.classList.add('active');
        }
        function closeMetaConnectModal() { DOMElements.metaConnectModal.classList.remove('active'); }

        // --- Scroller Logic ---
        function initializeScroller() {
            const scrollers = document.querySelectorAll(".scroller");
            const carouselData = [
                { src: "https://i.imgur.com/RzmcLQd.png", title: "Bomber Jacket" }, { src: "https://i.imgur.com/5dUY1BS.png", title: "Skincare" },
                { src: "https://i.imgur.com/zAQhPWu.png", title: "Spices" }, { src: "https://i.imgur.com/wnNbifw.png", title: "Botanical Facial Crème" },
                { src: "https://i.imgur.com/lO7J2VN.png", title: "Coffee Freaks" }, { src: "https://i.imgur.com/Kn25ag2.png", title: "Sneakers" },
                { src: "https://i.imgur.com/wRHLkot.png", title: "Composite Ad" }, { src: "https://i.imgur.com/90tB2Gc.png", title: "Radiant Serum" },
                { src: "https://i.imgur.com/CgRamm8.png", title: "Purifying Clay Mask" }, { src: "https://i.imgur.com/ozbQKtz.png", title: "Modern Chair" },
                { src: "https://i.imgur.com/NCisB59.png", title: "Acoustic Guitar" }, { src: "https://i.imgur.com/Gr7uHLH.png", title: "Watch" },
                { src: "https://i.imgur.com/X6v7j3R.png", title: "Headphones" }, { src: "https://i.imgur.com/ozNyrpZ.png", title: "Camera" },
                { src: "https://i.imgur.com/F1gINsg.png", title: "Drone" }, { src: "https://i.imgur.com/yZgDYMe.png", title: "Floral Skincare" },
                { src: "https://i.imgur.com/HBhYJio.png", title: "Modern Skincare" }, { src: "https://i.imgur.com/STmo7rw.png", title: "Luxury Perfume" },
                { src: "https://i.imgur.com/WbD8Fm4.png", title: "Tech Gadgets" }, { src: "https://i.imgur.com/4mfZLFF.png", title: "Fitness Supplement" },
                { src: "https://i.imgur.com/wyilFF1.png", title: "Outdoor Wear" }, { src: "https://i.imgur.com/ozTttVi.png", title: "Watch Ad" },
                { src: "https://i.imgur.com/HIxo7BS.png", title: "Shoe Ad" }, { src: "https://i.imgur.com/MxWnqDu.png", title: "Skincare Set" },
                { src: "https://i.imgur.com/vBK0u09.png", title: "Perfume Ad" }, { src: "https://i.imgur.com/gsaAUW7.png", title: "Foundation Ad" },
                { src: "https://i.imgur.com/r0kRMIq.png", title: "Serum Ad" },
                { src: "https://i.imgur.com/sbKrFep.png", title: "Before Example 2" }, { src: "https://i.imgur.com/PvoIuCN.png", title: "After Example 2" },
                { src: "https://i.imgur.com/RCRgEIj.png", title: "AI Ad Example 3" }, { src: "https://i.imgur.com/NXeFCWd.png", title: "AI Ad Example 4" },
            ];
            scrollers.forEach(scroller => {
              const scrollerInner = scroller.querySelector(".scroller__inner");
              if (!scrollerInner) return;
              const fragment = document.createDocumentFragment();
              [...carouselData, ...carouselData].forEach(item => {
                const img = document.createElement('img');
                img.src = item.src; img.alt = item.title;
                img.onerror = () => { img.src = `https://placehold.co/180x180/374151/9CA3AF?text=Error`; };
                fragment.appendChild(img);
              });
              scrollerInner.appendChild(fragment);
              if (!window.matchMedia("(prefers-reduced-motion: reduce)").matches) {
                  scroller.setAttribute("data-animated", true);
              }
            });
        }

        // --- Main App Logic ---
        async function handleGenerateAd() {
            const { backgroundPromptInput, generateAdBtn, overlay, overlayText, adImage, adCopyContainer, adCopyText, canvasControls, launchToMetaContainer } = DOMElements;
            const prompt = backgroundPromptInput.value.trim();
            if (!prompt || !productImageBase64) return showMessageBox('Please enter a prompt and upload an image.', true);

            generateAdBtn.disabled = true;
            generateAdBtn.innerHTML = `Generating...`;
            overlay.classList.remove('hidden');
            
            try {
                overlayText.textContent = 'Analyzing product...';
                const analysisResult = await callSecureApi('productAnalysis', { contents: [{ parts: [ { text: "Identify the main product and its key features in the image. Focus on a factual description of what the item is, for use in an ad campaign." }, { inlineData: { mimeType: "image/jpeg", data: productImageBase64 } } ] }] });
                const productDescription = analysisResult?.candidates?.[0]?.content?.parts?.[0]?.text || "product";

                overlayText.textContent = 'Generating ad copy...';
                const adCopyPrompt = `Create a compelling, short ad for a ${productDescription.toLowerCase()} with a background of: "${prompt}". Provide a punchy headline and a brief body text. Emphasize botanical ingredients and scientific benefits. Format as: Headline: [Your Headline] Body: [Your Body Text]`;
                const adCopyResult = await callSecureApi('adCopy', { contents: [{ role: "user", parts: [{ text: adCopyPrompt }] }] });
                const adCopy = adCopyResult?.candidates?.[0]?.content?.parts?.[0]?.text || "Failed to generate copy.";
                adCopyText.textContent = adCopy;

                overlayText.textContent = 'Compositing final ad image...';
                const compositePrompt = `Create a professional marketing ad. The background should be: "${prompt}". Place the provided product image prominently. Integrate the ad copy seamlessly into the design. Ad copy: "${adCopy}". Ensure the final image is visually appealing and high-resolution.`;
                const compositeResult = await callSecureApi('adImageComposite', { contents: [{ parts: [ { text: compositePrompt }, { inlineData: { mimeType: "image/jpeg", data: productImageBase64 } } ] }], generationConfig: { responseModalities: ['TEXT', 'IMAGE'] } });
                finalAdImageBase64 = compositeResult?.candidates?.[0]?.content?.parts?.

