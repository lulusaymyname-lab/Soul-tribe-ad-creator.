<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ad & Campaign Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <!-- Conditionally loaded PayPal SDK -->
    <script id="paypal-sdk-script"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background: #0b0b15; color: #fff; margin: 0; }
        .loading-overlay { display: flex; align-items: center; justify-content: center; }
        .ad-preview-image { width: 100%; height: 100%; object-fit: cover; }
        .select2-container--default .select2-selection--multiple { background-color: #1f2937; border-radius: 0.75rem; border: 2px solid #4b5563; padding: 0.5rem; }
        .select2-container--default .select2-selection--multiple .select2-selection__rendered { color: #fff; }
        .select2-container--default .select2-selection--multiple .select2-selection__choice { background-color: #4f46e5; color: white; border: none; border-radius: 0.5rem; }
        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove { color: white; }
        .select2-dropdown { background-color: #1f2937; border: 1px solid #4b5563; }
        .select2-container--default .select2-results__option--highlighted[aria-selected] { background-color: #4f46e5; }
        .select2-results__option { color: #d1d5db; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 100; }
        .modal.active { display: flex; }
        @keyframes scroll { to { transform: translate(calc(-50% - 0.5rem)); } }
        .scroller { max-width: 100%; overflow: hidden; -webkit-mask: linear-gradient(90deg, transparent, white 20%, white 80%, transparent); mask: linear-gradient(90deg, transparent, white 20%, white 80%, transparent); }
        .scroller__inner { display: flex; gap: 1rem; padding-block: 1rem; width: max-content; animation: scroll 60s linear infinite; }
        .scroller__inner img { height: 180px; width: auto; border-radius: 0.75rem; object-fit: cover; }
        .scroller[data-animated="true"] { overflow: hidden; }
        .scroller[data-animated="true"] .scroller__inner { width: max-content; flex-wrap: nowrap; }
        .scroller:hover .scroller__inner { animation-play-state: paused; }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div id="landingPage">
        <header class="text-center py-12 px-5 bg-gradient-to-b from-[#1b1b2f] to-[#0b0b15]">
            <h1 class="text-4xl font-bold mb-2">Soul Tribe Ad & Campaign Generator</h1>
            <p class="text-gray-300 text-lg">Create scroll-stopping ads in seconds with AI-powered design</p>
            <a href="#appSections" class="mt-6 inline-block bg-pink-600 text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:bg-pink-700 transition">Try Now (Test Drive)</a>
        </header>
        <section class="py-16 px-6 max-w-7xl mx-auto">
            <h2 class="text-3xl font-bold text-center mb-4">What You Can Create</h2>
            <p class="text-center text-lg text-gray-400 mb-12 max-w-3xl mx-auto">Here are real examples generated by the Soul Tribe Ad & Campaign Generator.</p>
            <div class="scroller" data-speed="slow"><div class="scroller__inner"></div></div>
        </section>
        <div id="appSections" class="py-16 px-6">
            <div class="flex justify-center space-x-4 mb-10">
                <button id="showAdGeneratorBtn" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-xl transition-colors">Ad Generator</button>
                <button id="showCampaignMakerBtn" class="bg-gray-800 text-white font-bold py-2 px-6 rounded-xl transition-colors">Campaign Maker</button>
                <button id="showDashboardBtn" class="bg-gray-800 text-white font-bold py-2 px-6 rounded-xl transition-colors">My Ads Dashboard</button>
            </div>
            <div id="adGenerator" class="flex flex-col lg:flex-row space-y-6 lg:space-y-0 lg:space-x-6">
                <div class="flex-1 flex flex-col space-y-6">
                    <div class="p-6 bg-gray-800 rounded-2xl border border-gray-700 shadow-sm"><h2 class="text-2xl font-bold text-white mb-4">Generate Ad</h2><p class="text-sm text-gray-400 mb-4">Describe the background, product placement, and ad copy style.</p><div class="bg-gray-700 text-white p-3 rounded-xl mb-4 text-sm border border-gray-600"><p><strong>Heads up!</strong> AI generation can be creative. You may need to run the generation process a few times. Be as specific as possible!</p></div><textarea id="backgroundPrompt" class="w-full h-24 p-3 text-base bg-gray-900 text-white border-2 border-gray-600 rounded-xl focus:ring-2 focus:ring-indigo-500" placeholder="A sleek marble podium..."></textarea><label id="uploadLabel" class="cursor-pointer mt-4 w-full text-gray-200 font-bold py-3 px-6 rounded-xl shadow-md text-center bg-gray-700 hover:bg-gray-600 block transition-colors">Upload Product Image<input type="file" id="productImageUpload" accept="image/*" class="hidden" /></label><button id="generateAdBtn" class="mt-4 w-full bg-indigo-600 text-white font-bold py-4 px-8 rounded-xl hover:bg-indigo-700 transition-colors">Generate Ad</button></div>
                    <div id="adCopyContainer" class="p-6 bg-gray-800 rounded-2xl border border-gray-700 hidden"><h3 class="text-xl font-bold mb-2">Generated Ad Copy:</h3><div id="adCopyText" class="text-gray-300"></div><button id="copyAdBtn" class="mt-4 w-full bg-gray-700 text-white font-bold py-3 px-6 rounded-xl hover:bg-gray-600 transition-colors">Copy Ad Text</button></div>
                    <button id="resetBtn" class="w-full bg-red-500 text-white font-bold py-3 px-6 rounded-xl hover:bg-red-600 transition-colors">Reset</button>
                </div>
                <div class="flex-1 flex flex-col items-center justify-center space-y-4">
                    <div class="relative w-full aspect-[1/1] overflow-hidden rounded-xl shadow-2xl border border-gray-700 bg-gray-900"><img id="adImage" class="ad-preview-image" /><div id="overlay" class="absolute inset-0 bg-gray-800/80 backdrop-blur-sm loading-overlay text-center p-4"><p id="overlayText" class="text-xl text-gray-300">Enter a prompt and upload an image.</p></div></div>
                    <div id="canvasControls" class="w-full hidden"><button id="downloadBtn" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-green-700 transition-colors">Download Your Ad</button></div>
                    <div id="launchToMetaContainer" class="w-full hidden mt-4"><h3 class="text-lg font-semibold text-center mb-2">Ready to Launch?</h3><button id="launchToMetaBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors">Launch on Facebook & Instagram</button></div>
                </div>
            </div>
            <div id="campaignMaker" class="hidden">
                <div class="p-6 bg-gray-800 rounded-2xl border border-gray-700 shadow-sm"><h2 class="text-2xl font-bold text-white mb-4">Create a Campaign</h2><p class="text-sm text-gray-400 mb-4">Generate copy and visual concepts for multiple platforms at once.</p><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><input type="text" id="productName" class="w-full p-3 text-base bg-gray-900 text-white border-2 border-gray-600 rounded-xl" placeholder="Enter Product Name or Type"><select id="platforms" multiple="multiple" class="w-full"><option value="facebook">Facebook</option><option value="instagram">Instagram</option><option value="pinterest">Pinterest</option><option value="x">X (Twitter)</option></select></div><label id="campaignUploadLabel" class="cursor-pointer w-full text-gray-200 font-bold py-3 px-6 rounded-xl shadow-md text-center bg-gray-700 hover:bg-gray-600 block transition-colors">(Optional) Upload Product Image<input type="file" id="campaignImageUpload" accept="image/*" class="hidden" /></label><button id="generateCampaignBtn" class="mt-4 w-full bg-indigo-600 text-white font-bold py-4 px-8 rounded-xl hover:bg-indigo-700 transition-colors">Generate Campaign</button></div>
                <div id="campaignOutput" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </div>
            <div id="myAdsDashboardSection" class="hidden">
                 <!-- Dashboard content can be added here -->
            </div>
        </div>
        <!-- Other sections like pricing can be added here -->
    </div>
    <!-- Modals can be added here -->
    <div id="messageBox" class="fixed inset-x-0 top-4 mx-auto p-4 bg-green-500 text-white rounded-lg shadow-lg text-center z-50 transform -translate-y-full opacity-0 max-w-md"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        // --- App State & Config ---
        const SECURE_API_ENDPOINT = '/api/generate';

        // --- DOM Elements ---
        const DOMElements = {
            productImageUpload: document.getElementById('productImageUpload'),
            uploadLabel: document.getElementById('uploadLabel'),
            backgroundPromptInput: document.getElementById('backgroundPrompt'),
            generateAdBtn: document.getElementById('generateAdBtn'),
            adImage: document.getElementById('adImage'),
            overlay: document.getElementById('overlay'),
            overlayText: document.getElementById('overlayText'),
            adCopyContainer: document.getElementById('adCopyContainer'),
            adCopyText: document.getElementById('adCopyText'),
            copyAdBtn: document.getElementById('copyAdBtn'),
            resetBtn: document.getElementById('resetBtn'),
            canvasControls: document.getElementById('canvasControls'),
            downloadBtn: document.getElementById('downloadBtn'),
            messageBox: document.getElementById('messageBox'),
            showAdGeneratorBtn: document.getElementById('showAdGeneratorBtn'),
            showCampaignMakerBtn: document.getElementById('showCampaignMakerBtn'),
            adGenerator: document.getElementById('adGenerator'),
            campaignMaker: document.getElementById('campaignMaker'),
            productNameInput: document.getElementById('productName'),
            generateCampaignBtn: document.getElementById('generateCampaignBtn'),
            campaignOutput: document.getElementById('campaignOutput'),
            campaignImageUpload: document.getElementById('campaignImageUpload'),
            campaignUploadLabel: document.getElementById('campaignUploadLabel'),
            showDashboardBtn: document.getElementById('showDashboardBtn'),
            myAdsDashboardSection: document.getElementById('myAdsDashboardSection'),
            launchToMetaContainer: document.getElementById('launchToMetaContainer'),
            launchToMetaBtn: document.getElementById('launchToMetaBtn'),
        };

        let productImageBase64 = null;
        let finalAdImageBase64 = null;
        let campaignImageBase64 = null;

        function showMessageBox(message, isError = false) {
            const { messageBox } = DOMElements;
            messageBox.textContent = message;
            messageBox.className = `fixed inset-x-0 top-4 mx-auto p-4 text-white rounded-lg shadow-lg text-center z-50 transform opacity-100 translate-y-0 max-w-md ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            setTimeout(() => {
                messageBox.className = messageBox.className.replace('opacity-100 translate-y-0', 'opacity-0 -translate-y-full');
            }, 5000);
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        async function callSecureApi(type, payload) {
            const response = await fetch(SECURE_API_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type, payload })
            });
            if (!response.ok) {
                const errorResult = await response.json().catch(() => ({ error: 'Failed to parse error from server.' }));
                throw new Error(errorResult.details || errorResult.error || `Server returned status: ${response.status}`);
            }
            return response.json();
        }

        async function handleGenerateAd() {
            const { backgroundPromptInput, generateAdBtn, overlay, overlayText, adImage, adCopyContainer, adCopyText, canvasControls, launchToMetaContainer } = DOMElements;
            const prompt = backgroundPromptInput.value.trim();
            if (!prompt || !productImageBase64) {
                return showMessageBox('Please enter a prompt and upload a product image.', true);
            }

            generateAdBtn.disabled = true;
            generateAdBtn.innerHTML = `Generating...`;
            overlay.style.display = 'flex';
            overlayText.textContent = 'Analyzing product...';

            try {
                const analysisResult = await callSecureApi('productAnalysis', { contents: [{ parts: [{ text: "Identify the main product and its key features in the image." }, { inlineData: { mimeType: "image/jpeg", data: productImageBase64 } }] }] });
                const productDescription = analysisResult?.candidates?.[0]?.content?.parts?.[0]?.text || "product";

                overlayText.textContent = 'Generating ad copy...';
                const adCopyPrompt = `Create a compelling, short ad for a ${productDescription.toLowerCase()} with a background of: "${prompt}". Provide a punchy headline and a brief body text. Emphasize botanical ingredients and scientific benefits. Format as: Headline: [Your Headline] Body: [Your Body Text]`;
                const adCopyResult = await callSecureApi('adCopy', { contents: [{ role: "user", parts: [{ text: adCopyPrompt }] }] });
                const adCopy = adCopyResult?.candidates?.[0]?.content?.parts?.[0]?.text || "Failed to generate ad copy.";
                adCopyText.textContent = adCopy;

                overlayText.textContent = 'Compositing final ad image...';
                const compositePrompt = `Create a professional marketing ad. The background should be: "${prompt}". Place the provided product image prominently. Integrate the ad copy seamlessly into the design. Ad copy: "${adCopy}". Ensure the final image is visually appealing and high-resolution.`;
                const compositeResult = await callSecureApi('adImageComposite', { contents: [{ parts: [{ text: compositePrompt }, { inlineData: { mimeType: "image/jpeg", data: productImageBase64 } }] }], generationConfig: { responseModalities: ['TEXT', 'IMAGE'] } });
                
                finalAdImageBase64 = compositeResult?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (finalAdImageBase64) {
                    adImage.src = `data:image/png;base64,${finalAdImageBase64}`;
                    overlay.style.display = 'none';
                    adCopyContainer.classList.remove('hidden');
                    canvasControls.classList.remove('hidden');
                    launchToMetaContainer.classList.remove('hidden');
                } else {
                    throw new Error('Failed to generate ad image from API response.');
                }
            } catch (error) {
                console.error('Ad Generation Error:', error);
                overlayText.textContent = `Error: ${error.message}`;
                showMessageBox(error.message, true);
            } finally {
                generateAdBtn.disabled = false;
                generateAdBtn.innerHTML = 'Generate Ad';
            }
        }

        async function handleGenerateCampaign() {
            const { productNameInput, generateCampaignBtn, campaignOutput } = DOMElements;
            const productName = productNameInput.value.trim();
            const platforms = $('#platforms').val();
            if (!productName || platforms.length === 0) {
                return showMessageBox('Please provide a product name and select at least one platform.', true);
            }

            generateCampaignBtn.disabled = true;
            generateCampaignBtn.textContent = 'Generating...';
            campaignOutput.innerHTML = `<div class="col-span-full text-center p-4 text-gray-400">Generating campaign text...</div>`;

            try {
                const basePrompt = `Create a social media campaign for the following platforms: ${platforms.join(', ')}. For each platform, provide a "headline", "ad_copy", "visual_concept", and "call_to_action". Emphasize botanical and scientific benefits for a product named "${productName}". Format as a single JSON array of objects.`;
                const campaignTextPayload = { contents: [{ role: "user", parts: [{ text: basePrompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "ARRAY", items: { type: "OBJECT", properties: { "platform_name": { "type": "STRING" }, "headline": { "type": "STRING" }, "ad_copy": { "type": "STRING" }, "visual_concept": { "type": "STRING" }, "call_to_action": { "type": "STRING" } }, required: ["platform_name", "headline", "ad_copy", "visual_concept", "call_to_action"] } } } };
                
                const textResult = await callSecureApi('campaignText', campaignTextPayload);
                const campaignData = JSON.parse(textResult?.candidates?.[0]?.content?.parts?.[0]?.text);
                
                if (!campaignData) throw new Error('Failed to parse campaign data from API.');
                
                campaignOutput.innerHTML = '';
                campaignData.forEach(platformData => {
                    const card = createCampaignCard(platformData);
                    campaignOutput.appendChild(card);
                });

                // Throttled image generation
                for (const platformData of campaignData) {
                    await new Promise(resolve => setTimeout(resolve, 2000)); // 2-second delay to avoid rate limits
                    await generateAndDisplayVisual(platformData, productName);
                }

            } catch (error) {
                console.error("Campaign Generation Error:", error);
                campaignOutput.innerHTML = `<div class="col-span-full text-center text-red-500">Failed to generate campaign: ${error.message}</div>`;
                showMessageBox(error.message, true);
            } finally {
                generateCampaignBtn.disabled = false;
                generateCampaignBtn.textContent = 'Generate Campaign';
            }
        }
        
        function createCampaignCard(platformData) {
            const platform = platformData.platform_name.toLowerCase().replace(/[^a-z0-9]/g, '');
            const card = document.createElement('div');
            card.className = 'p-6 bg-gray-800 rounded-2xl border border-gray-700 shadow-md';
            card.innerHTML = `<h3 class="text-xl font-bold">${platformData.platform_name}</h3><p class="text-sm text-gray-400 mt-2"><strong>Headline:</strong> ${platformData.headline}</p><p class="text-sm text-gray-400"><strong>Ad Copy:</strong> ${platformData.ad_copy}</p><p class="text-sm text-gray-400"><strong>Visual Concept:</strong> ${platformData.visual_concept}</p><p class="text-sm text-gray-400"><strong>Call to Action:</strong> ${platformData.call_to_action}</p><div class="mt-4 aspect-video bg-gray-700 rounded-lg flex items-center justify-center"><img id="img-${platform}" class="hidden w-full h-full object-cover rounded-lg" /><div id="loader-${platform}" class="text-gray-400">Generating visual...</div></div>`;
            return card;
        }

        async function generateAndDisplayVisual(platformData, productName) {
            const platform = platformData.platform_name.toLowerCase().replace(/[^a-z0-9]/g, '');
            const imgEl = document.getElementById(`img-${platform}`);
            const loaderEl = document.getElementById(`loader-${platform}`);
            
            try {
                const visualResult = await callSecureApi('campaignVisual', { prompt: `Marketing photo: ${platformData.visual_concept} for ${productName}.` });
                const visualBase64 = visualResult.predictions?.[0]?.bytesBase64Encoded;
                if (visualBase64) {
                    imgEl.src = `data:image/png;base64,${visualBase64}`;
                    imgEl.classList.remove('hidden');
                    loaderEl.classList.add('hidden');
                } else {
                    throw new Error('API returned no image data.');
                }
            } catch (error) {
                console.error(`Visual generation failed for ${platform}:`, error);
                loaderEl.textContent = 'Visual generation failed.';
                loaderEl.classList.add('text-red-400');
            }
        }
        
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                DOMElements.uploadLabel.textContent = `Uploaded: ${file.name}`;
                productImageBase64 = await fileToBase64(file);
            }
        }

        function handleReset() {
            // Reset logic
        }

        function setupEventListeners() {
            DOMElements.generateAdBtn.addEventListener('click', handleGenerateAd);
            DOMElements.generateCampaignBtn.addEventListener('click', handleGenerateCampaign);
            DOMElements.resetBtn.addEventListener('click', handleReset);
            DOMElements.productImageUpload.addEventListener('change', handleImageUpload);
            // ... other listeners
        }

        window.addEventListener('load', () => {
            $(document).ready(function() { $('#platforms').select2(); });
            setupEventListeners();
            // Load PayPal script only on the live site
            if (window.self === window.top) {
                const paypalScript = document.getElementById('paypal-sdk-script');
                paypalScript.src = "https://www.paypal.com/sdk/js?client-id=AQRSVj2hhAqWy7TCjAWRB4mxj5Y3B87JdMGtBUIGCEKMFMWLvep2pRGDGyjTebgI2N760RB1jUrsmZGW&currency=USD";
                paypalScript.onload = () => {
                    // setupPayPalButtons(); you would call your paypal setup function here
                };
            }
        });
    </script>
</body>
</html>


